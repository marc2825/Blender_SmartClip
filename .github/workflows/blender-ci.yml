name: Blender CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

jobs:
  headless-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      BLENDER_VERSION: 4.0.2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Blender Runtime Dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 \
            libxrender1 \
            libxrandr2 \
            libxfixes3 \
            libxi6 \
            libxkbcommon0 \
            libxxf86vm1 \
            libsm6 \
            libegl1 \
            libgl1 \
            libdbus-1-3

      - name: Install Blender
        shell: bash
        run: |
          set -euxo pipefail
          series="${BLENDER_VERSION%.*}"   # e.g. 4.0.2 -> 4.0
          archive="blender-${BLENDER_VERSION}-linux-x64.tar.xz"
          url="https://download.blender.org/release/Blender${series}/${archive}"
          wget -q "${url}"
          tar -xf "${archive}"
          echo "${PWD}/blender-${BLENDER_VERSION}-linux-x64" >> "${GITHUB_PATH}"

      - name: Sanity Check
        run: blender --version

      - name: Python Syntax Check
        run: |
          find src tests scripts -name '*.py' -print0 \
            | xargs -0 python -m py_compile

      - name: Run Headless Addon Tests
        run: |
          blender \
            --background \
            --factory-startup \
            --python tests/headless_test_runner.py
